#!/usr/bin/env bash

set -euo pipefail

here=$(cd "$(dirname "$BASH_SOURCE")"; pwd)
source "$here/env.bash"

core_root="$PROJECT_ROOT/core"

POSITIONAL=()
while [[ $# -gt 0 ]]; do
    key="$1"
    case $key in
        (-profile)
            profile_="$2"
            shift
            shift
            ;;
        (*)
            POSITIONAL+=("$1")
            shift
            ;;
    esac
done

profile_=${profile_:-release}

(
    cd "$core_root"
    case $profile_ in
        (release)
            cargo build --all --release
            ;;
        (debug)
            cargo build --all
            ;;
        (*)
            echo "Unknown profile $profile_"
            exit 1
    esac

    cp -f target/"$profile_/$MODULE_ORIGINAL" "$MODULE_RENAMED"
    version=$(cargo pkgid | cut -d'#' -f2 | cut -d: -f2)
    echo "$version".1 | tr -d $'\n' > DYN-VERSION
    cask build
)
(
    cd "$PROJECT_ROOT"
    cask build
)
