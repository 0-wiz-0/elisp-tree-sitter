parameters:
  oses: []

steps:

# TODO: Set $BUNDLE_VERSION from a previous job instead. Or even better, use
# Emacs Lisp to upload the files, instead of a bash script.
- bash: |
    set -e
    BUNDLE_VERSION=$(cask eval "(progn (require 'tree-sitter-langs-build) (princ tree-sitter-langs--version))")
    echo "##vso[task.setvariable variable=BUNDLE_VERSION]$BUNDLE_VERSION"
  workingDirectory: langs

- ${{ each os in parameters.oses }}:
  - task: DownloadPipelineArtifact@2
    displayName: Retrieve tree-sitter-grammars-${{ os }}-$(BUNDLE_VERSION).tar.gz
    inputs:
      artifact: tree-sitter-grammars-${{ os }}
      path: langs
  - task: DownloadPipelineartifact@2
    displayName: Retrieve tree-sitter-langs-$(BUNDLE_VERSION).tar for ${{ os }}
    inputs:
      artifact: tree-sitter-langs-${{ os }}
      path: langs/${{ os }}

- bash: ls
  workingDirectory: langs

- task: ExtractFiles@1
  displayName: Extract tree-sitter-grammars archives (.tar.gz)
  inputs:
    archiveFilePatterns: langs/tree-sitter-grammars-*.tar.gz
    destinationFolder: langs/bin
    cleanDestinationFolder: no

- bash: ls
  workingDirectory: langs/bin

- bash: cask package
  displayName: Create a "universal" tree-sitter-langs package
  workingDirectory: langs

# TODO: Publish as well, instead of having to do so manually afterwards.
- ${{ each os in parameters.oses }}:
  - bash: ./bin/upload-to-bintray
    displayName: Upload tree-sitter-grammars bundles to bintray os=${{ os }}
    env:
      BINTRAY_API_KEY: $(BINTRAY_API_KEY)
      BINTRAY_PKG: tree-sitter-grammars
      BINTRAY_LOCAL_PATH: langs/tree-sitter-grammars-${{ os }}-$(BUNDLE_VERSION).tar.gz
      BINTRAY_REMOTE_PATH: tree-sitter-grammars-${{ os }}-$(BUNDLE_VERSION).tar.gz
  - bash: ./bin/upload-to-bintray
    displayName: Upload tree-sitter-langs packages to bintray os=${{ os }}
    env:
      BINTRAY_API_KEY: $(BINTRAY_API_KEY)
      BINTRAY_PKG: tree-sitter-langs
      BINTRAY_LOCAL_PATH: langs/${{ os }}/tree-sitter-langs-$(BUNDLE_VERSION).tar
      BINTRAY_REMOTE_PATH: ${{ os }}/packages/tree-sitter-langs-$(BUNDLE_VERSION).tar

- bash: ./bin/upload-to-bintray
  displayName: Upload tree-sitter-langs "universal" package to bintray
  env:
    BINTRAY_API_KEY: $(BINTRAY_API_KEY)
    BINTRAY_PKG: tree-sitter-langs
    BINTRAY_LOCAL_PATH: langs/dist/tree-sitter-langs-$(BUNDLE_VERSION).tar
    BINTRAY_REMOTE_PATH: packages/tree-sitter-langs-$(BUNDLE_VERSION).tar
